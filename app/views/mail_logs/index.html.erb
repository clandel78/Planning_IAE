<h1>Mail Logs</h1>
<p>Historique des envois de mails vers MailGun, et la réponse obtenue. (Statut consultable 5 jours)</p>

<div class="container-fluid p-3 shadow-sm">
  <%= form_tag request.path, method: :get do %>
    <div class="form-group">
      <div class="row">

        <div class="col-sm-5">
          <%= label_tag :to, "Destinataire" %>
          <div class="input-group">
            <%= text_field_tag :to, params[:to], include_blank:true, onchange:'this.form.submit()', class:"form-control form-control-sm" %>
            <span class="input-group-btn">
                <%= submit_tag 'Filtrer', class:"btn btn-sm btn-success" %>
            </span>
          </div> 
        </div>
        
      </div>
    </div>
  <% end %>
</div>

<div style="overflow-x: auto;">
  <table class="table table-hover table-sm">
    <thead>
      <tr>
        <th><%= sortable :user_id do %>De<% end %></th>
        <th><%= sortable :to do %>À<% end %></th>
        <th><%= sortable :subject do %>Sujet<% end %></th>
        <th><%= sortable :created_at, default: true do %>Il y a<% end %></th>
        <th>Statut</th>
        <th colspan="2"></th>
      </tr>
    </thead>

    <tbody>
      <% @mail_logs.each do |mail_log| %>
        <tr>
          <td><%= mail_log.user_id == 0 ? "Système" : User.find(mail_log.user_id).nom_et_prénom %></td>
          <td><%= mail_log.to %></td>
          <td><%= mail_log.subject %></td>
          <td><%= time_ago_in_words mail_log.created_at %></td>
          <td>
            <% if mail_log.created_at > 5.days.ago %>
              <% if status = @result["items"].find{|item| item["message"]["headers"]["message-id"] == mail_log.message_id } %>
                <span class="text-danger">KO</span>

              <% else %>
                <span class="text-success">OK</span>
              <% end %>
            <% end %>
          </td>
          <td><%= link_to 'Voir', mail_log %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="page_info">
    <%= page_entries_info @mail_logs %>
  </div>

  <%= will_paginate @mail_logs, renderer: WillPaginate::ActionView::BootstrapLinkRenderer %>